---
layout: post
title: 《学习微服务》02、微服务如何拆分
---

微服务就是将单体应用架构进行细粒度的服务化拆分，并将各个服务交由小团队维护其开发、测试、上线、运维的整个生命周期。这就有几个问题：

1. 何时进行单体应用的服务化拆分？
2. 拆分可有标准可依？

---

## 何时进行单体应用的服务化拆分？

项目初期，通常是需要求快，所以项目需求少，代码量少，只求快速上线验证可行性。通常这个阶段团队成员规模都较小，使用单体应用架构进行开发、测试、部署、运维很合理。  
当项目用户增长，可行性验证通过，就可以进一步加入新特性。这时就会扩大团队规模，每个人负责开发不同功能，不同功能的开发进度不同，质量也难以统一衡量，难免发生相互影响，每次的打包部署必须保证每个人提交的代码都测试通过才行，已经开始影响效率。  
这样多功能模块混在一起开发，还会带来线上服务的不稳定。如果某人负责的代码存在隐患，上线后发生内存泄漏，一段时间后进程异常结束，就会导致整个服务无法访问。
建议，当单体应用的开发人员超过 10 人，就可以考虑服务化拆分了 。

## 怎么进行服务化拆分？

- **纵向拆分**，从业务维度拆分。标准是按照业务的关联度决定。关联密切的业务适合拆分为一个服务，功能相对独立的业务也适合独立为一个服务。
- **横向拆分**，从公用且独立维度拆分。标准是是否被多个其他服务调用，且以来的资源独立不与其他服务耦合。

## 微服务化前的准备

技术更新迭代，新技术解决了老的开发运维痛点的同时也必将带来新的“坑”，微服务也不例外。服务化之前必须先考虑到以下问题：

- **服务如何定义**。使用接口，无论通过什么通讯协议，HTTP 或 RPC，服务间的调用都要通过接口描述约定，约定内容包括接口名、接口参数和接口返回值。
- **服务发布与订阅**。微服务至少都是进程隔离，独立部署后，服务提供者要对外暴露自己的地址，服务消费者要能找到所需服务的地址。这就需要一个“登记处”，让它来记录每个服务提供者的地址以及提供服务调用者查询，这就是注册中心。
- **服务监控**。对于服务我们关心 QPS（调用量）、AvgTime（平均耗时）和 P999（99.9%的请求性能在说少毫秒内）指标 。这就需要我们有一种监控方案，能覆盖业务埋点、数据收集、数据处理、数据展示等功能。
- **服务治理**。微服务化带来了独立服务数量的增长，他们间的依赖关系也复杂了。如果一个服务性能有问题势必造成依赖它的服务收到影响。可以设定一个调用性能阈值，如果在一定时间内都超过这个值，就让依赖的服务直接返回，称为**熔断**，是服务治理的常用手段之一。
- **故障定位**。微服务化后，一次用户调用可能依赖多服务，不同服务在不同节点，如果出现问题，需要能找出请求路径，排查出故障点。

## 总结

微服务的拆分并不是越细越好，要按业务现状与团队水平以合理的粒度拆分。**建议每个人员负责不超过 3 个大的服务为标准**。
